<!-- @format -->

<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ØªØµÙ†ÙŠÙ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø§Øª - Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</title>
    <style>
      :root {
        --bg: #0d0b0b;
        --card: #1d1a1a;
        --muted: #9fb0d0;
        --text: #c3c3c3;
        --accent: #6aa9ff;
        --border: rgba(255, 255, 255, 0.12);
        --good: #45d483;
        --warn: #ffcc66;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          "Noto Sans Arabic",
          "Noto Naskh Arabic",
          Tahoma,
          Arial,
          sans-serif;
        background:
          radial-gradient(
            1200px 600px at 20% -10%,
            rgba(12, 5, 5, 0.25),
            transparent 60%
          ),
          radial-gradient(
            900px 500px at 90% 10%,
            rgba(12, 5, 5, 0.18),
            transparent 60%
          ),
          var(--bg);
        color: var(--text);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
        background: rgba(2, 1, 1, 0.72);
        border-bottom: 1px solid var(--border);
      }
      .wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 18px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 22px;
      }
      .sub {
        color: var(--bg);
        font-size: 13px;
        line-height: 1.5;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 8px;
      }
      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 280px 1fr;
        }
      }
      .panel {
        background: rgba(24, 10, 10, 0.75);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25);
      }
      .controls {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      input[type="text"],
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        outline: none;
      }
      input[type="text"]::placeholder {
        color: rgba(213, 213, 213, 0.766);
      }
      .checks {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 6px;
      }
      .check {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        border: 1px dashed rgba(255, 255, 255, 0.16);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.14);
        color: var(--bg);
      }
      .check input {
        transform: scale(1.1);
      }
      .btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: 1px solid var(--border);
        background: rgba(106, 169, 255, 0.16);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
      }
      button:hover {
        background: rgba(106, 169, 255, 0.24);
      }
      .stat {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.7;
      }
      .list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 680px) {
        .list {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (min-width: 1100px) {
        .list {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }
      .card {
        background: rgba(8, 1, 1, 0.75);
        border: 1px solid var(--border);
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
        display: grid;
        grid-template-rows: 180px auto;
        min-height: 320px;
        margin-bottom: 12px;
        margin-left: 22px;
      }
      .img {
        background: rgba(255, 255, 255, 0.06);
        position: relative;
        overflow: hidden;
      }
      .img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        filter: saturate(1.05);
      }
      .badges {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .badge {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(8px);
      }
      .badge.good {
        border-color: rgba(69, 212, 131, 0.35);
        background: rgba(69, 212, 131, 0.16);
      }
      .badge.warn {
        border-color: rgba(255, 204, 102, 0.35);
        background: rgba(255, 204, 102, 0.14);
      }
      .content {
        padding: 12px 12px 14px;
        display: grid;
        gap: 8px;
      }
      .title {
        font-size: 15px;
        font-weight: 700;
        line-height: 1.4;
        color: var(--text);
      }
      .meta {
        display: grid;
        gap: 6px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.88);
      }
      .muted {
        color: var(--muted);
      }
      .stars {
        letter-spacing: 1px;
      }
      .price {
        font-weight: 700;
      }
      .foot {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }
      .tiny {
        font-size: 12px;
      }
      .filebox {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 4px;
      }
      .filebox input[type="file"] {
        max-width: 100%;
      }
      .note {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.14);
        border-radius: 14px;
        padding: 10px 12px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.6;
      }
      .kbd {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(78, 0, 0, 0.07);
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 12px;
      }
      /* Lightbox */
      .lightbox {
        position: fixed;
        inset: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        place-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.25s;
      }
      .lightbox.open {
        display: flex;
        opacity: 1;
      }
      .lb-img {
        max-width: 90vw;
        max-height: 85vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
      }
      .lb-close {
        position: absolute;
        top: 20px;
        left: 20px; /* RTL aware: usually close is top-left or top-right? Let's put left for RTL */
        background: none;
        border: none;
        color: #1c1a1a;
        font-size: 40px;
        cursor: pointer;
        padding: 20px;
        line-height: 1;
        z-index: 1001;
      }
      .lb-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #000000;
        font-size: 40px;
        cursor: pointer;
        padding: 20px;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .lb-nav:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .lb-prev {
        right: 20px;
      } /* RTL: Next is Left, Prev is Right? Or logical? Lets use arrows visually */
      .lb-next {
        left: 20px;
      }
      .lb-count {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: #000000;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.5);
        padding: 4px 12px;
        border-radius: 99px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>Ø¹Ø±Ø¶ ÙˆØªØµÙ†ÙŠÙ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ù‚Ø§Ø¹Ø§Øª (Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ù†Ø¬ÙˆÙ…/Ø§Ù„Ù†ÙˆØ¹) ğŸ¨âœ¨</h1>
        <div class="sub">
          Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù‘Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±). ØªÙ‚Ø¯Ø± Ø¨Ø¹Ø¯ ØªØ®ØªØ§Ø± Ù…Ù„Ù JSON Ù…Ù†
          Ø¬Ù‡Ø§Ø²Ùƒ Ø¹Ù„Ø´Ø§Ù† ØªØ­Ø¯Ù‘Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.
        </div>
      </div>
    </header>

    <main class="wrap">
      <div class="grid">
        <aside class="panel">
          <div class="controls">
            <div class="row">
              <label>Ø¨Ø­Ø« (Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ù…Ø¯ÙŠÙ†Ø©)</label>
              <input
                id="q"
                type="text"
                placeholder="Ù…Ø«Ø§Ù„: Ø±ÙˆØªØ§Ù†Ø§ØŒ Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ritz..."
              />
            </div>

            <div class="row">
              <label>Ø§Ù„Ù†ÙˆØ¹</label>
              <select id="type">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="hotel">ÙÙ†Ø§Ø¯Ù‚</option>
                <option value="hall">Ù‚Ø§Ø¹Ø§Øª</option>
              </select>
            </div>

            <div class="row">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… (Ù„Ù„ÙÙ†Ø§Ø¯Ù‚ ÙÙ‚Ø·)</label>
              <select id="stars">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="5">5 Ù†Ø¬ÙˆÙ…</option>
                <option value="4">4 Ù†Ø¬ÙˆÙ…</option>
                <option value="3">3 Ù†Ø¬ÙˆÙ…</option>
                <option value="0">Ø¨Ø¯ÙˆÙ† Ù†Ø¬ÙˆÙ…/ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
              </select>
            </div>

            <div class="row">
              <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
              <select id="city">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
              </select>
            </div>

            <div class="row">
              <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
              <select id="sort">
                <option value="price_desc">Ø§Ù„Ø³Ø¹Ø±: Ø§Ù„Ø£ØºÙ„Ù‰ â†’ Ø§Ù„Ø£Ø±Ø®Øµ</option>
                <option value="price_asc">Ø§Ù„Ø³Ø¹Ø±: Ø§Ù„Ø£Ø±Ø®Øµ â†’ Ø§Ù„Ø£ØºÙ„Ù‰</option>
                <option value="stars_desc">Ø§Ù„Ù†Ø¬ÙˆÙ…: Ø§Ù„Ø£Ø¹Ù„Ù‰ â†’ Ø§Ù„Ø£Ù‚Ù„</option>
                <option value="stars_asc">Ø§Ù„Ù†Ø¬ÙˆÙ…: Ø§Ù„Ø£Ù‚Ù„ â†’ Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
                <option value="name_asc">Ø§Ù„Ø§Ø³Ù…: Ø£ â†’ ÙŠ</option>
                <option value="name_desc">Ø§Ù„Ø§Ø³Ù…: ÙŠ â†’ Ø£</option>
              </select>
            </div>

            <div class="checks">
              <div class="check">
                <input id="hasPriceOnly" type="checkbox" />
                <div>
                  <div>Ø§Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù… Ø³Ø¹Ø±</div>
                  <div class="tiny muted">
                    Ø§Ù„Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø³Ø¹Ø± ÙŠÙ†Ø­Ø·ÙˆÙ† Ø¢Ø®Ø± Ø´ÙŠ Ø£Ùˆ ÙŠÙ†Ø®ÙÙˆÙ†.
                  </div>
                </div>
              </div>

              <div class="check">
                <input id="hasPackagesOnly" type="checkbox" />
                <div>
                  <div>Ø§Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù… Ø¨Ø§ÙƒÙŠØ¬Ø§Øª</div>
                  <div class="tiny muted">
                    Ø­Ø³Ø¨ Ø®Ø§Ù†Ø© hasPackages ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
                  </div>
                </div>
              </div>
            </div>

            <div class="btns">
              <button id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
              <button id="exportBtn">ØªØµØ¯ÙŠØ± CSV</button>
            </div>

            <div class="note">
              <b>Ù…Ù„Ø§Ø­Ø¸Ø© ØµØ±ÙŠØ­Ø©:</b> Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯Ù†Ø§ Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ù…ØµØ¯Ø± (Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚
              Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†)ØŒ ÙˆØ¥Ø°Ø§ ØµÙˆØ±Ø© Ù…Ø§ Ø§Ø´ØªØºÙ„Øª ÙÙ‡Ø°ÙŠ ØºØ§Ù„Ø¨Ø§Ù‹ Ø­Ù…Ø§ÙŠØ©
              Hotlink Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù‡Ù…â€”Ø§Ù„ØµÙØ­Ø© Ø¨ØªØ¬Ø±Ù‘Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ØµÙˆØ±Ø© Ø¨Ø¯ÙŠÙ„Ø©. <br /><br />
              <b>Ù…Ù„Ø§Ø­Ø¸Ø© ØµØ±ÙŠØ­Ø©:</b> Ø§Ù„Ø³Ø¹Ø± Ø¹Ù†Ø¯Ù†Ø§ ÙŠØ¬ÙŠ ÙƒÙ†Øµ (Ù…Ø«Ù„:
              <span class="kbd">12 BHD/person</span> Ø£Ùˆ
              <span class="kbd">Hall from 2000 BHD</span>).<br />
              Ø§Ù„ØµÙØ­Ø© ØªØ³ØªØ®Ø±Ø¬ Ø±Ù‚Ù… â€œØªÙ‚Ø±ÙŠØ¨ÙŠâ€ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ÙØ±Ø² ÙÙ‚Ø·. ÙŠØ¹Ù†ÙŠ Ø§Ù„ÙØ±Ø² Ù…Ù…ØªØ§Ø²
              ÙƒÙ€â€œÙ…Ø¤Ø´Ø±â€ØŒ Ù…Ùˆ ÙØ§ØªÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ˜„
            </div>

            <div class="row">
              <label>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <div class="filebox">
                <input id="file" type="file" accept="application/json" />
                <button id="loadFileBtn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
              </div>
              <div class="tiny muted">
                Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ØŒ Ø¨ØªØªØ­Ø¯Ù‘Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹.
              </div>
            </div>

            <div class="stat" id="stat"></div>
          </div>
        </aside>

        <section class="panel">
          <div class="list" id="list"></div>
        </section>
      </div>
    </main>

    <div id="lightbox" class="lightbox">
      <button class="lb-close" onclick="closeLightbox()">&times;</button>
      <button class="lb-nav lb-prev" onclick="prevImage(event)">
        &#10094;
      </button>
      <button class="lb-nav lb-next" onclick="nextImage(event)">
        &#10095;
      </button>
      <img id="lbImg" class="lb-img" src="" alt="" />
      <div id="lbCount" class="lb-count"></div>
    </div>

    <script>
      // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ù…Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© =====
      // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© =====
      window.__VENUES_DATA__ = {};
      const DATA_URL = "bahrain_wedding_venues_images_fixed.json";

      // ===== Helpers =====
      function norm(s) {
        return (s ?? "").toString().trim();
      }

      function getVenueType(v) {
        // category: "Hotels" Ø£Ùˆ "Wedding Halls"
        const cat = (v.category || "").toLowerCase();
        if (cat.includes("hotel")) return "hotel";
        if (cat.includes("hall")) return "hall";
        // fallback
        return v.starRating ? "hotel" : "hall";
      }

      function starText(n) {
        if (!n || n <= 0) return "â€”";
        return "â˜…â˜…â˜…â˜…â˜…".slice(0, n) + "â˜†â˜†â˜†â˜†â˜†".slice(0, 5 - n);
      }

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø¹Ø± Ø±Ù‚Ù…ÙŠ Ù…Ù† Ù†Øµ Ø§Ù„Ø³Ø¹Ø±
      function parsePrice(priceText) {
        const t = (priceText || "").toString();
        if (!t)
          return {
            effective: null,
            kind: "unknown",
            perPerson: null,
            hall: null,
          };

        const lower = t.toLowerCase();

        // Ø§Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ù‚Ø¯ ØªÙƒÙˆÙ† 25.41 Ø¥Ù„Ø®)
        const nums = Array.from(t.matchAll(/\d+(?:\.\d+)?/g))
          .map((m) => parseFloat(m[0]))
          .filter((n) => !Number.isNaN(n));

        // per person detection
        const perPersonHints =
          /(\/person|per\s*person|bhd\/person|bd\/person|person\s*\(avg\)|\(avg\))/i.test(
            t,
          );
        let perPerson = null;
        if (perPersonHints && nums.length) {
          // Ø®Ø° Ø£ØµØºØ± Ø±Ù‚Ù… ÙƒÙ€ "Ø­Ø¯ Ø£Ø¯Ù†Ù‰" Ù…Ù†Ø·Ù‚ÙŠ
          perPerson = Math.min(...nums);
        }

        // hall detection (Hall from 2000 BHD) Ø£Ùˆ (price shown)
        let hall = null;
        const hallFrom = t.match(/hall\s*from\s*(\d+(?:\.\d+)?)\s*(bhd|bd)/i);
        if (hallFrom) {
          hall = parseFloat(hallFrom[1]);
        } else if (/\bprice\s*shown\b/i.test(t) && nums.length) {
          hall = nums[0];
        } else if (!perPersonHints && nums.length) {
          // Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù† per-person ÙˆØ§Ø¶Ø­ØŒ Ùˆ Ø§Ù„Ø±Ù‚Ù… ÙƒØ¨ÙŠØ± (>=100) ØºØ§Ù„Ø¨Ù‹Ø§ Ø³Ø¹Ø± Ù‚Ø§Ø¹Ø©/Ø­Ø¬Ø²
          const big = nums.filter((n) => n >= 100);
          if (big.length) hall = Math.min(...big);
        }

        let effective = null;
        let kind = "unknown";
        if (perPerson != null) {
          effective = perPerson;
          kind = "perPerson";
        } else if (hall != null) {
          effective = hall;
          kind = "hall";
        }

        return { effective, kind, perPerson, hall };
      }

      function formatPrice(v) {
        if (!v.priceText) return "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        return v.priceText;
      }

      function formatEffective(p) {
        if (p.effective == null) return "â€”";
        if (p.kind === "perPerson") return `${p.effective} Ø¯.Ø¨/Ø´Ø®Øµ`;
        if (p.kind === "hall") return `${p.effective} Ø¯.Ø¨ (Ø­Ø¬Ø²/Ù‚Ø§Ø¹Ø©)`;
        return `${p.effective} Ø¯.Ø¨`;
      }

      function safeImg(url) {
        const u = norm(url);
        if (!u) {
          // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø³ÙŠØ·Ø© (SVG data URI)
          const svg =
            encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
                <defs>
                  <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="#203059"/>
                    <stop offset="1" stop-color="#0b1020"/>
                  </linearGradient>
                </defs>
                <rect width="1200" height="700" fill="url(#g)"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9fb0d0" font-size="48" font-family="Arial">No Image</text>
              </svg>`);
          return `data:image/svg+xml;charset=utf-8,${svg}`;
        }
        return u;
      }

      function swapImg(imgEl) {
        try {
          const raw =
            imgEl && imgEl.dataset && imgEl.dataset.srcs
              ? imgEl.dataset.srcs
              : "";
          const parts = raw.split("||").map(norm).filter(Boolean);
          if (parts.length) {
            const next = parts.shift();
            imgEl.dataset.srcs = parts.join("||");
            imgEl.src = safeImg(next);
            return;
          }
        } catch (e) {}
        if (imgEl) {
          imgEl.onerror = null;
          imgEl.src = safeImg(null);
        }
      }

      function toCSV(rows) {
        const esc = (s) => `"${(s ?? "").toString().replace(/"/g, '""')}"`;
        const header = [
          "Ø§Ù„Ø§Ø³Ù…",
          "Ø§Ù„Ù†ÙˆØ¹",
          "Ø§Ù„Ù†Ø¬ÙˆÙ…",
          "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
          "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†ØµÙŠ",
          "Ø³Ø¹Ø± (ØªÙ‚Ø±ÙŠØ¨ÙŠ)",
          "Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø±",
          "Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©",
          "Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©",
          "Ø§Ù„Ø±Ø§Ø¨Ø·",
        ];
        const lines = [header.map(esc).join(",")];
        for (const r of rows) {
          lines.push(
            [
              r.titleAr || r.titleEn,
              r.typeAr,
              r.stars || "",
              r.city,
              r.priceText || "",
              r.priceValue ?? "",
              r.priceKind,
              r.indoor || "",
              r.outdoor || "",
              r.fullUrl || "",
            ]
              .map(esc)
              .join(","),
          );
        }
        return lines.join("\n");
      }

      function download(filename, content, mime) {
        const blob = new Blob([content], { type: mime });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 500);
      }

      // ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§ Ù„Ø´ÙƒÙ„ Ù…ÙˆØ­Ù‘Ø¯ =====
      function buildVenues(raw) {
        const hotels = (raw.hotels || []).map((h) => {
          const p = parsePrice(h.price);
          const type = getVenueType(h);
          return {
            id: "H-" + (h.nid ?? h.number ?? Math.random()),
            type,
            typeAr: "ÙÙ†Ø¯Ù‚",
            stars: h.starRating ?? null,
            titleAr: h.titleArabic ?? "",
            titleEn: h.titleEnglish ?? "",
            city: h.city ?? "",
            hasPackages: (h.hasPackages || "")
              .toString()
              .toLowerCase()
              .includes("yes"),
            indoor: h.maxGuestsIndoor ?? "",
            outdoor: h.maxGuestsOutdoor ?? "",
            priceText: h.price ?? null,
            priceValue: p.effective,
            priceKind: p.kind,
            priceDetail: p,
            imgUrls: (
              h.imageUrls || [h.mainImage].concat(h.photos || [])
            ).filter(Boolean),
            fullUrl: h.fullUrl ?? "",
          };
        });

        const halls = (raw.independentHalls || []).map((h) => {
          const p = parsePrice(h.price);
          const type = getVenueType(h);
          return {
            id: "W-" + (h.nid ?? h.number ?? Math.random()),
            type,
            typeAr: "Ù‚Ø§Ø¹Ø©",
            stars: null,
            titleAr: h.titleArabic ?? "",
            titleEn: h.titleEnglish ?? "",
            city: h.city ?? "",
            hasPackages: (h.hasPackages || "")
              .toString()
              .toLowerCase()
              .includes("yes"),
            indoor: h.maxGuestsIndoor ?? "",
            outdoor: h.maxGuestsOutdoor ?? "",
            priceText: h.price ?? null,
            priceValue: p.effective,
            priceKind: p.kind,
            priceDetail: p,
            imgUrls: (
              h.imageUrls || [h.mainImage].concat(h.photos || [])
            ).filter(Boolean),
            fullUrl: h.fullUrl ?? "",
          };
        });

        return [...hotels, ...halls];
      }

      // ===== State =====
      let venues = [];

      const el = {
        q: document.getElementById("q"),
        type: document.getElementById("type"),
        stars: document.getElementById("stars"),
        city: document.getElementById("city"),
        sort: document.getElementById("sort"),
        hasPriceOnly: document.getElementById("hasPriceOnly"),
        hasPackagesOnly: document.getElementById("hasPackagesOnly"),
        list: document.getElementById("list"),
        stat: document.getElementById("stat"),
        resetBtn: document.getElementById("resetBtn"),
        exportBtn: document.getElementById("exportBtn"),
        file: document.getElementById("file"),
        loadFileBtn: document.getElementById("loadFileBtn"),
      };

      function fillCities() {
        const cities = Array.from(
          new Set(venues.map((v) => norm(v.city)).filter(Boolean)),
        ).sort((a, b) => a.localeCompare(b, "ar"));
        // reset options
        el.city.innerHTML =
          '<option value="all">Ø§Ù„ÙƒÙ„</option>' +
          cities.map((c) => `<option value="${c}">${c}</option>`).join("");
      }

      function matchesQuery(v, q) {
        if (!q) return true;
        const hay = [v.titleAr, v.titleEn, v.city].join(" ").toLowerCase();
        return hay.includes(q.toLowerCase());
      }

      function applyFilters() {
        const q = norm(el.q.value);
        const type = el.type.value;
        const stars = el.stars.value;
        const city = el.city.value;
        const needPrice = el.hasPriceOnly.checked;
        const needPkg = el.hasPackagesOnly.checked;

        let out = venues.filter((v) => {
          if (!matchesQuery(v, q)) return false;

          if (type !== "all" && v.type !== type) return false;

          if (city !== "all" && norm(v.city) !== city) return false;

          if (stars !== "all") {
            const s = (v.stars ?? 0).toString();
            if (stars === "0") {
              if ((v.stars ?? 0) > 0) return false;
            } else {
              if (s !== stars) return false;
            }
          }

          if (needPrice && v.priceValue == null) return false;
          if (needPkg && !v.hasPackages) return false;

          return true;
        });

        out = sortVenues(out, el.sort.value);

        render(out);
      }

      function sortVenues(list, mode) {
        const arr = [...list];
        const byNullLast = (a, b, getter, desc = false) => {
          const av = getter(a);
          const bv = getter(b);
          const an = av == null || Number.isNaN(av);
          const bn = bv == null || Number.isNaN(bv);
          if (an && bn) return 0;
          if (an) return 1;
          if (bn) return -1;
          return desc ? bv - av : av - bv;
        };

        if (mode === "price_desc") {
          arr.sort((a, b) => byNullLast(a, b, (x) => x.priceValue, true));
        } else if (mode === "price_asc") {
          arr.sort((a, b) => byNullLast(a, b, (x) => x.priceValue, false));
        } else if (mode === "stars_desc") {
          arr.sort((a, b) => byNullLast(a, b, (x) => x.stars ?? 0, true));
        } else if (mode === "stars_asc") {
          arr.sort((a, b) => byNullLast(a, b, (x) => x.stars ?? 0, false));
        } else if (mode === "name_asc") {
          arr.sort((a, b) =>
            norm(a.titleAr || a.titleEn).localeCompare(
              norm(b.titleAr || b.titleEn),
              "ar",
            ),
          );
        } else if (mode === "name_desc") {
          arr.sort((a, b) =>
            norm(b.titleAr || b.titleEn).localeCompare(
              norm(a.titleAr || a.titleEn),
              "ar",
            ),
          );
        }
        return arr;
      }

      function render(list) {
        el.list.innerHTML = list
          .map((v) => {
            const name = norm(v.titleAr) || norm(v.titleEn) || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
            const sub = [
              norm(v.titleEn)
                ? `<span class="muted">${htmlEscape(v.titleEn)}</span>`
                : "",
            ]
              .filter(Boolean)
              .join(" â€¢ ");
            const stars =
              v.type === "hotel"
                ? `<span class="stars" title="${v.stars || 0} Ù†Ø¬ÙˆÙ…">${starText(v.stars || 0)}</span>`
                : `<span class="muted">â€”</span>`;
            const priceBadge =
              v.priceValue != null
                ? v.priceKind === "perPerson"
                  ? "good"
                  : "warn"
                : "";
            const priceLabel =
              v.priceValue != null
                ? formatEffective(v.priceDetail)
                : "Ø¨Ø¯ÙˆÙ† Ø³Ø¹Ø±";
            const pkg = v.hasPackages
              ? `<span class="badge good">Ø¨Ø§ÙƒÙŠØ¬Ø§Øª</span>`
              : `<span class="badge">Ø¨Ø¯ÙˆÙ† Ø¨Ø§ÙƒÙŠØ¬Ø§Øª</span>`;
            const typeBadge =
              v.type === "hotel"
                ? `<span class="badge">ÙÙ†Ø¯Ù‚</span>`
                : `<span class="badge">Ù‚Ø§Ø¹Ø©</span>`;

            const imgUrls = (v.imgUrls || []).map(norm).filter(Boolean);
            const firstImg = imgUrls[0] || "";
            const restImgs = imgUrls.slice(1).join("||");

            return `
                <article class="card">
                  <div class="img">
                    <img
                      src="${safeImg(firstImg)}"
                      data-srcs="${htmlEscape(restImgs)}"
                      alt="${htmlEscape(name)}"
                      loading="lazy"
                      referrerpolicy="no-referrer"
                      onerror="swapImg(this)"
                      style="cursor: zoom-in"
                      onclick="openGallery('${v.id}')"
                    />
                    <div class="badges">
                      ${typeBadge}
                      ${pkg}
                      <span class="badge ${priceBadge}">${priceLabel}</span>
                    </div>
                  </div>
                  <div class="content">
                    <div class="title">${htmlEscape(name)}</div>
                    <div class="meta">
                      <div><span class="muted">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span> ${htmlEscape(norm(v.city) || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯")}</div>
                      <div><span class="muted">Ø§Ù„Ù†Ø¬ÙˆÙ…:</span> ${stars}</div>
                      <div><span class="muted">Ø§Ù„Ø³Ø¹Ø© (Ø¯Ø§Ø®Ù„ÙŠØ©):</span> ${htmlEscape(norm(v.indoor) || "â€”")}</div>
                      <div><span class="muted">Ø§Ù„Ø³Ø¹Ø© (Ø®Ø§Ø±Ø¬ÙŠØ©):</span> ${htmlEscape(norm(v.outdoor) || "â€”")}</div>
                      <div><span class="muted">Ø§Ù„Ø³Ø¹Ø± (Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±):</span> <span class="price">${htmlEscape(formatPrice(v))}</span></div>
                    </div>
                    <div class="foot">
                      <div class="tiny">${v.priceValue != null ? "âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø¹Ø± Ù„Ù„ÙØ±Ø²" : "â„¹ï¸ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± Ù…ØªÙˆÙØ±"}
                      </div>
                      <div class="tiny">
                        ${v.fullUrl ? `<a href="${v.fullUrl}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>` : ""}
                      </div>
                    </div>
                  </div>
                </article>
              `;
          })
          .join("");

        const total = venues.length;
        const shown = list.length;
        const hotelsCount = list.filter((v) => v.type === "hotel").length;
        const hallsCount = shown - hotelsCount;
        const withPrice = list.filter((v) => v.priceValue != null).length;

        el.stat.innerHTML = `
              <div>Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <b>${shown}</b> Ù…Ù† <b>${total}</b></div>
              <div>ÙÙ†Ø§Ø¯Ù‚: <b>${hotelsCount}</b> â€¢ Ù‚Ø§Ø¹Ø§Øª: <b>${hallsCount}</b></div>
              <div>Ø¹Ù†Ø¯Ù‡Ù… Ø³Ø¹Ø± (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„ÙØ±Ø²): <b>${withPrice}</b></div>
            `;
      }

      function htmlEscape(s) {
        return (s ?? "")
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function wire() {
        for (const k of [
          "q",
          "type",
          "stars",
          "city",
          "sort",
          "hasPriceOnly",
          "hasPackagesOnly",
        ]) {
          el[k].addEventListener(k === "q" ? "input" : "change", applyFilters);
        }

        el.resetBtn.addEventListener("click", () => {
          el.q.value = "";
          el.type.value = "all";
          el.stars.value = "all";
          el.city.value = "all";
          el.sort.value = "price_desc";
          el.hasPriceOnly.checked = false;
          el.hasPackagesOnly.checked = false;
          applyFilters();
        });

        el.exportBtn.addEventListener("click", () => {
          const current = sortVenues(
            venues.filter((v) => true),
            el.sort.value,
          );
          const csv = toCSV(current);
          download("venues.csv", csv, "text/csv;charset=utf-8");
        });

        el.loadFileBtn.addEventListener("click", async () => {
          const f = el.file.files && el.file.files[0];
          if (!f) {
            alert("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù JSON Ø£ÙˆÙ„ ğŸ˜„");
            return;
          }
          try {
            const txt = await f.text();
            const raw = JSON.parse(txt);
            venues = buildVenues(raw);
            fillCities();
            applyFilters();
          } catch (e) {
            console.error(e);
            alert("Ø§Ù„Ù…Ù„Ù Ù…Ùˆ JSON ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø§ ÙŠÙ†Ù‚Ø±Ø£ ğŸ‘€");
          }
        });
      }

      // init
      wire();

      // fetch data
      fetch(DATA_URL)
        .then((res) => res.json())
        .then((data) => {
          window.__VENUES_DATA__ = data;
          venues = buildVenues(data);
          fillCities();
          applyFilters();

          const el = document.getElementById("stat"); // ensure el is available or reuse scope
          if (el) {
            const msg = document.createElement("div");
            msg.style.cssText =
              "color:#45d483; margin-top:8px; font-size:12px;";
            msg.textContent = "âœ¨ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON Ø¨Ù†Ø¬Ø§Ø­";
            el.appendChild(msg);
          }
        })
        .catch((err) => {
          console.error(err);
          const el = document.getElementById("stat");
          if (el) {
            const msg = document.createElement("div");
            msg.style.cssText =
              "color:#ffcc66; margin-top:8px; font-size:12px;";
            msg.textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JSON: " + err.message;
            el.appendChild(msg);
          }
        });

      // ===== Lightbox Logic =====
      let lbImages = [];
      let lbIndex = 0;
      const lb = document.getElementById("lightbox");
      const lbImg = document.getElementById("lbImg");
      const lbCount = document.getElementById("lbCount");

      window.openGallery = function (id) {
        const v = venues.find((x) => x.id === id);
        if (!v || !v.imgUrls.length) return;

        // Use the image URLs from data.
        // If we want to use the 'swapped' image because of error, it's tricky since render recreated the DOM.
        // But typically we just retry loading the original URLs in the lightbox.
        lbImages = v.imgUrls.map((u) => safeImg(u));
        lbIndex = 0;
        updateLightbox();
        lb.classList.add("open");
        document.body.style.overflow = "hidden";
      };

      window.closeLightbox = function () {
        lb.classList.remove("open");
        document.body.style.overflow = "";
      };

      window.nextImage = function (e) {
        if (e) e.stopPropagation();
        lbIndex = (lbIndex + 1) % lbImages.length;
        updateLightbox();
      };

      window.prevImage = function (e) {
        if (e) e.stopPropagation();
        lbIndex = (lbIndex - 1 + lbImages.length) % lbImages.length;
        updateLightbox();
      };

      function updateLightbox() {
        lbImg.src = lbImages[lbIndex];
        lbCount.textContent = `${lbIndex + 1} / ${lbImages.length}`;
      }

      document.addEventListener("keydown", (e) => {
        if (!lb.classList.contains("open")) return;
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") nextImage(); // RTL: Left Arrow -> Next (visually left)
        if (e.key === "ArrowRight") prevImage(); // RTL: Right Arrow -> Prev (visually right)
      });

      lb.addEventListener("click", (e) => {
        if (e.target === lb) closeLightbox();
      });
    </script>
  </body>
</html>
